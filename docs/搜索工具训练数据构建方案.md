# 搜索工具训练数据构建方案

## 1. 概述

本方案旨在构建高质量的搜索工具训练数据集，用于训练大语言模型有效使用搜索工具的能力。通过精心设计的训练数据，我们希望模型能够学会：

1. 何时需要使用搜索工具
2. 如何构建高质量的搜索查询
3. 如何解析和利用搜索结果
4. 何时需要进行多轮搜索

## 2. 数据来源

### 2.1 基础数据集

我们将利用以下开源数据集作为基础：

- **Natural Questions (NQ)**: Google发布的真实用户问题数据集
- **TriviaQA**: 包含大量事实性问题的数据集
- **HotpotQA**: 需要多步推理的复杂问题数据集
- **ELI5**: "解释像我5岁一样"的长答案问题数据集
- **KILT**: 知识密集型任务的统一数据集

### 2.2 时效性数据

为了训练模型处理需要最新信息的查询，我们将构建以下类型的数据：

- **时事问题**: 关于近期事件、新闻的问题
- **最新研究**: 关于科学、技术最新进展的问题
- **产品信息**: 关于最新产品、服务的问题

### 2.3 多样化领域

确保数据覆盖多个领域：

- 科学技术
- 历史文化
- 体育娱乐
- 地理信息
- 人物传记
- 商业经济
- 健康医疗

## 3. 数据构建流程

### 3.1 基本数据结构

每个训练样本包含以下组件：

```json
{
  "data_source": "来源数据集",
  "prompt": [
    {
      "role": "system",
      "content": "系统提示，指导模型使用搜索工具"
    },
    {
      "role": "user",
      "content": "用户问题"
    }
  ],
  "ability": "search",
  "reward_model": {
    "style": "rule",
    "ground_truth": "标准答案",
    "search_metrics": {
      "ideal_queries": ["理想查询1", "理想查询2"],
      "key_information": ["关键信息1", "关键信息2"]
    }
  },
  "extra_info": {
    "split": "train/val/test",
    "index": 123,
    "answer": "完整标准答案",
    "question": "原始问题",
    "need_tools_kwargs": true,
    "tools_kwargs": {
      "web_search": {
        "create_kwargs": {
          "expected_info": "预期信息",
          "search_difficulty": "easy/medium/hard"
        }
      }
    },
    "metadata": {
      "domain": "问题领域",
      "temporal_nature": "timeless/time_sensitive",
      "complexity": "simple/multi_hop",
      "search_rounds_needed": 1  // 预计需要的搜索轮数
    }
  }
}
```

### 3.2 数据增强策略

#### 3.2.1 查询变体生成

为每个问题生成多种可能的有效查询变体：

- 使用同义词替换
- 调整查询结构（疑问句、陈述句）
- 增加/减少特定性
- 添加/移除上下文信息

#### 3.2.2 难度梯度设计

按照搜索难度构建梯度：

1. **简单查询**: 直接将问题转换为查询即可找到答案
2. **中等查询**: 需要提取关键词并重组查询
3. **复杂查询**: 需要多轮搜索，每轮基于前一轮结果调整查询

#### 3.2.3 多轮搜索场景设计

特别构建需要多轮搜索的问题：

- **信息收集型**: 第一轮获取概览，后续轮次深入细节
- **细化查询型**: 第一轮查询过于宽泛，需要基于结果细化查询
- **验证对比型**: 需要搜索多个相关信息进行对比验证

### 3.3 模拟搜索结果

为了训练数据的完整性，我们将模拟搜索结果：

1. **真实API调用**: 使用实际搜索API获取结果（批量处理以控制成本）
2. **结果存储**: 将API返回结果存储为训练数据的一部分
3. **结果变体**: 为同一查询生成多种可能的结果变体（好/中/差）

```json
"simulated_search_results": {
  "query1": [
    {"quality": "good", "results": [{...}, {...}]},
    {"quality": "medium", "results": [{...}, {...}]},
    {"quality": "poor", "results": [{...}, {...}]}
  ],
  "query2": [...]
}
```

### 3.4 标注与质量控制

#### 3.4.1 自动标注

- 使用NLP技术自动提取关键信息点
- 自动评估查询质量和结果相关性
- 基于答案覆盖率自动计算搜索效果

#### 3.4.2 人工审核

- 抽样审核自动标注结果
- 人工标注复杂案例
- 验证多轮搜索的必要性和有效性

## 4. 特殊训练数据类型

### 4.1 负面案例

包含以下类型的负面案例：

- **不需要搜索的问题**: 训练模型识别何时不需要搜索
- **无效查询示例**: 展示不良查询及其结果
- **过度搜索案例**: 展示不必要的多轮搜索

### 4.2 搜索失败恢复

设计搜索失败后的恢复策略训练数据：

- **查询重构**: 当初始查询未返回有用结果时
- **结果解析失败**: 当结果包含但模型未能提取关键信息时
- **部分信息获取**: 当只获得部分所需信息时的补充策略

### 4.3 时效性处理

针对时效性信息的特殊处理：

- **日期感知查询**: 包含"最新"、"2024年"等时间信息的查询
- **结果时效性评估**: 训练模型评估搜索结果的时效性
- **信息更新策略**: 当发现信息可能过时时的处理方法

## 5. 实施步骤

### 5.1 数据收集与预处理

1. 下载并整合基础数据集
2. 清洗和标准化问答对
3. 分类问题（领域、复杂度、时效性）

### 5.2 查询生成与搜索结果获取

1. 为每个问题生成候选查询
2. 批量调用搜索API获取结果
3. 存储查询-结果对

### 5.3 数据标注与增强

1. 自动标注关键信息点
2. 生成多轮搜索场景
3. 添加元数据和评估指标

### 5.4 数据格式化与验证

1. 转换为训练格式（parquet）
2. 验证数据完整性和质量
3. 划分训练/验证/测试集

### 5.5 持续更新机制

1. 定期添加新的时效性问题
2. 更新已有时效性问题的答案
3. 基于模型表现反馈调整数据分布

## 6. 评估指标

### 6.1 数据质量指标

- **领域覆盖率**: 各领域问题的分布均衡性
- **难度分布**: 简单/中等/复杂问题的比例
- **查询多样性**: 不同查询模式的覆盖程度
- **时效性比例**: 时效性vs永恒性问题的比例

### 6.2 模型评估指标

- **查询质量**: 模型生成查询的质量评分
- **搜索效率**: 达到答案所需的平均搜索轮数
- **信息提取**: 从搜索结果中提取关键信息的能力
- **最终答案质量**: 基于搜索结果生成的答案质量

## 7. 示例数据

### 7.1 单轮搜索示例

```json
{
  "prompt": [
    {
      "role": "system",
      "content": "You are a helpful assistant that can search the web for information..."
    },
    {
      "role": "user",
      "content": "谁是现任联合国秘书长？"
    }
  ],
  "reward_model": {
    "style": "rule",
    "ground_truth": "安东尼奥·古特雷斯是现任（第九任）联合国秘书长，自2017年1月1日上任。",
    "search_metrics": {
      "ideal_queries": ["现任联合国秘书长", "联合国秘书长 古特雷斯", "UN Secretary-General current"],
      "key_information": ["安东尼奥·古特雷斯", "2017年1月1日", "第九任"]
    }
  },
  "extra_info": {
    "metadata": {
      "domain": "国际组织",
      "temporal_nature": "time_sensitive",
      "complexity": "simple",
      "search_rounds_needed": 1
    }
  }
}
```

### 7.2 多轮搜索示例

```json
{
  "prompt": [
    {
      "role": "system",
      "content": "You are a helpful assistant that can search the web for information..."
    },
    {
      "role": "user",
      "content": "比较一下ChatGPT和Claude的优缺点"
    }
  ],
  "reward_model": {
    "style": "rule",
    "ground_truth": "详细的比较分析...",
    "search_metrics": {
      "ideal_queries": [
        "ChatGPT vs Claude 比较",
        "ChatGPT 优缺点",
        "Claude AI 优缺点",
        "大语言模型 性能对比"
      ],
      "key_information": [
        "ChatGPT优点：...",
        "ChatGPT缺点：...",
        "Claude优点：...",
        "Claude缺点：...",
        "性能对比数据"
      ]
    }
  },
  "extra_info": {
    "metadata": {
      "domain": "人工智能",
      "temporal_nature": "time_sensitive",
      "complexity": "multi_hop",
      "search_rounds_needed": 3
    }
  }
}
```

## 8. 数据规模与分布

### 8.1 目标规模

- **训练集**: 50,000个样本
- **验证集**: 5,000个样本
- **测试集**: 5,000个样本

### 8.2 数据分布

- **领域分布**: 确保各领域均衡覆盖
- **难度分布**: 简单(40%)、中等(40%)、复杂(20%)
- **搜索轮数**: 单轮(60%)、双轮(30%)、三轮及以上(10%)
- **时效性**: 永恒性(70%)、时效性(30%)

## 9. 实现计划

### 9.1 阶段一：基础数据集构建（1个月）

- 收集和整合开源数据集
- 实现基本的数据处理流程
- 构建10,000个基础训练样本

### 9.2 阶段二：高级功能实现（2个月）

- 实现查询变体生成
- 添加多轮搜索场景
- 实现搜索结果模拟

### 9.3 阶段三：扩展与优化（1个月）

- 扩展到目标规模
- 优化数据分布
- 实施质量控制

### 9.4 阶段四：持续更新（长期）

- 建立时效性数据更新机制
- 基于模型反馈优化数据集
- 扩展到新领域和语言
